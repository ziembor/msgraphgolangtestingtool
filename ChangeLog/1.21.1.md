# Change Log: Version 1.21.1

**Release Date:** 2026-01-07

This is a **CRITICAL SECURITY PATCH** release that fixes a HIGH severity OData injection vulnerability discovered in v1.21.0. All users of v1.21.0 should upgrade immediately.

## Security Fixes

### ðŸ”’ CRITICAL: Fixed OData Injection Vulnerability in searchAndExport (CVE-2026-MSGRAPH-001)

**Severity:** HIGH (CVSS 7.5)

**Vulnerability Description:**
The `searchAndExport` function contained an OData injection vulnerability where the `-messageid` parameter was directly interpolated into an OData filter without validation or sanitization. This allowed authenticated attackers to bypass filter constraints and export arbitrary mailbox content.

**Attack Example:**
```powershell
# Malicious input that exported entire mailbox instead of single message
./msgraphgolangtestingtool.exe -action searchandexport \
    -messageid "' or 1 eq 1 or internetMessageId eq '" ...
```

**Fix Implementation:**

1. **Input Validation (Primary Defense):**
   - Added `validateMessageID()` function in `src/utils.go`
   - Enforces RFC 5322 Message-ID format: `<local@domain>`
   - Rejects quote characters (`'`, `"`, `\`)
   - Rejects OData operators (`or`, `and`, `eq`, `ne`, `lt`, `gt`, `le`, `ge`, `not`)
   - Validates maximum length (998 characters per RFC 5322)

2. **OData Escaping (Defense-in-Depth):**
   - Added quote escaping in `searchAndExport()` function in `src/handlers.go`
   - Single quotes escaped using OData rules: `'` â†’ `''`

3. **Comprehensive Testing:**
   - Added 30+ security-focused unit tests in `TestValidateMessageID()`
   - Tests cover uppercase/lowercase injection attempts
   - Tests verify RFC 5322 format enforcement
   - All tests passing

**Impact:**
- **Before Fix:** Authenticated users could export arbitrary mailbox content
- **After Fix:** Only valid RFC 5322 Message-IDs are accepted, injection attempts are blocked

**Files Modified:**
- `src/utils.go` - Added `validateMessageID()` function (lines 217-256)
- `src/config.go` - Added validation call in `validateConfiguration()` (lines 437-440)
- `src/handlers.go` - Added OData quote escaping in `searchAndExport()` (lines 580-583)
- `src/msgraphgolangtestingtool_test.go` - Added `TestValidateMessageID()` with 30 test cases (lines 454-508)
- `SECURITY.md` - Documented vulnerability and fix (CVE-2026-MSGRAPH-001)
- `IMPROVEMENTS.md` - Added Recommendation #9 with remediation guidance

**Affected Versions:**
- v1.21.0 (released 2026-01-06)

**Recommended Actions:**
1. **Immediate:** Upgrade from v1.21.0 to v1.21.1
2. **Audit:** Review CSV logs (`_msgraphgolangtestingtool_searchandexport_*.csv`) for suspicious Message-ID patterns
3. **Assess:** Check Microsoft 365 audit logs for unauthorized mailbox access between 2026-01-06 and upgrade date
4. **Verify:** Run `go test -C src -v -run TestValidateMessageID` to verify fix

## Testing

All unit tests passing:
```bash
$ go test -C src -v -run TestValidateMessageID
=== RUN   TestValidateMessageID
--- PASS: TestValidateMessageID (0.00s)
    --- PASS: TestValidateMessageID/valid_standard (0.00s)
    --- PASS: TestValidateMessageID/injection_or_operator (0.00s)
    --- PASS: TestValidateMessageID/injection_and_operator (0.00s)
    [... 27 more test cases ...]
PASS
ok      msgraphgolangtestingtool        1.614s
```

## Upgrade Instructions

### From v1.21.0:
```powershell
# 1. Stop any running instances
# 2. Download v1.21.1
# 3. Replace executable
# 4. Verify version
./msgraphgolangtestingtool.exe -version
# Should show: 1.21.1

# 5. Test with valid Message-ID
./msgraphgolangtestingtool.exe -action searchandexport \
    -messageid "<valid@example.com>" ...
# Should work

# 6. Verify injection is blocked
./msgraphgolangtestingtool.exe -action searchandexport \
    -messageid "' or 1 eq 1 or '" ...
# Should fail with: "invalid message ID: contains OData operators"
```

## Credit

- **Discovered by:** AI Security Review (2026-01-07)
- **Fixed by:** Development Team (2026-01-07)

## Notes

- This is a patch release (1.21.0 â†’ 1.21.1) containing only security fixes
- No new features or breaking changes
- Existing functionality for `exportinbox` and other actions unchanged
- No impact on legitimate `searchandexport` usage with valid Message-IDs

---

**SECURITY ADVISORY:** If you have been using v1.21.0 in production, please review your mailbox audit logs for any suspicious activity and upgrade immediately.

                          ..ooOO END OOoo..
