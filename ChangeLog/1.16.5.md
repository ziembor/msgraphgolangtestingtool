## [1.16.5] - 2026-01-05

### Added

- **Interactive script release.ps1** - Automated release workflow for pushing to GitHub and building release ZIPs

- **Integration Test Architecture** (IMPROVEMENTS.md Recommendation #8 - CRITICAL FIX)
  - Created `src/shared.go` (896 lines) - Central repository for ALL shared business logic with no build tags
  - Created `src/msgraphgolangtestingtool_integration_test.go` - New automated Go integration tests using testing package
  - **Dual Test Modes**:
    1. **Interactive Test Tool** (`integration_test_tool.go`) - Manual testing with user prompts and confirmation dialogs
    2. **Automated Integration Tests** (`msgraphgolangtestingtool_integration_test.go`) - CI/CD friendly Go tests with write operation protection
  - **Comprehensive Test Coverage**:
    - `TestIntegration_Prerequisites()` - Validates environment variables
    - `TestIntegration_GraphClientCreation()` - Tests Graph client setup
    - `TestIntegration_ListEvents()` - Calendar events retrieval (read-only)
    - `TestIntegration_ListInbox()` - Inbox messages retrieval (read-only)
    - `TestIntegration_SendEmail()` - Email sending (requires `MSGRAPH_INTEGRATION_WRITE=true`)
    - `TestIntegration_CreateCalendarEvent()` - Calendar event creation (requires `MSGRAPH_INTEGRATION_WRITE=true`)
    - `TestIntegration_ValidateConfiguration()` - Unit tests for configuration validation
  - **Updated INTEGRATION_TESTS.md** - Comprehensive documentation including:
    - Architecture explanation with build tag diagram
    - Setup instructions for both test modes
    - Usage examples for interactive and automated tests
    - Troubleshooting guide
    - Security best practices
    - CI/CD integration examples (GitHub Actions)

### Changed

- **Complete Integration Test Architecture Refactoring**:
  - Eliminated **777 lines of duplicate code** by extracting shared logic to `src/shared.go`
  - Rewrote `src/msgraphgolangtestingtool.go` (551 lines) with `//go:build !integration` tag
  - Updated `src/integration_test_tool.go` (297 lines) to use shared.go - removed all duplicate code
  - Deleted `src/msgraphgolangtestingtool_lib.go` - was causing redeclaration errors and build conflicts

- **Build Tag Separation** (proper build mode isolation):
  - `shared.go` - No build tag (always compiled, shared by all builds)
  - `msgraphgolangtestingtool.go` - `//go:build !integration` (main CLI app only, excluded from integration builds)
  - `integration_test_tool.go` - `//go:build integration` (interactive test tool only)
  - `msgraphgolangtestingtool_integration_test.go` - `//go:build integration` (automated tests only)
  - `cert_windows.go` - `//go:build windows` (Windows certificate store, platform-specific)
  - `cert_stub.go` - `//go:build !windows` (stub for non-Windows platforms)

- **Main CLI Application** (`msgraphgolangtestingtool.go`):
  - Removed all duplicate business logic (now in shared.go)
  - Retained only CLI-specific code:
    - Flag parsing (`parseAndConfigureFlags()`)
    - Environment variable application (`applyEnvVars()`)
    - Signal handling (`setupSignalHandling()`)
    - Service initialization (`initializeServices()`)
    - Action dispatching (`executeAction()`)
    - Verbose output (`printVerboseConfig()`, `getEnvVariables()`)
  - Clean separation of concerns following DRY principle

### Fixed

- **CRITICAL: Build Failures with `-tags=integration`** (IMPROVEMENTS.md #8)
  - **Issue**: Multiple `main()` declarations and redeclaration errors when building with `-tags=integration`
  - **Root Cause**: `msgraphgolangtestingtool_lib.go` duplicated 777 lines causing symbol conflicts
  - **Solution**: Deleted duplicate library file, extracted all shared logic to `shared.go`, added proper build tags
  - **Result**: Integration tests now compile and run successfully

- **Code Duplication** (DRY Principle Violation)
  - **Before**: Business logic duplicated across main app, interactive tool, and lib file
  - **After**: Single source of truth in `shared.go`, zero duplication
  - **Impact**: 777 lines of duplicate code eliminated, easier maintenance, consistent behavior

- **Build Mode Conflicts**
  - **Before**: Couldn't build integration tests due to multiple `main()` functions
  - **After**: Proper build tag separation allows independent compilation:
    - `go build ./src` → Builds main CLI app only (14MB)
    - `go test -tags=integration -c ./src` → Compiles integration tests (15MB)
    - `go run -tags=integration ./src` → Runs interactive test tool

### Technical Details

- **Shared Logic Architecture** (`src/shared.go`):
  - Version embedding via `//go:embed VERSION`
  - Action constants (`ActionGetEvents`, `ActionSendMail`, `ActionSendInvite`, `ActionGetInbox`)
  - `Config` struct with 18 well-documented configuration fields
  - Core business logic functions:
    - `setupGraphClient()` - Microsoft Graph client initialization
    - `getCredential()` - Authentication credential selection
    - `createCertCredential()` - Certificate-based authentication
    - `listEvents()` - Calendar event retrieval with retry logic
    - `sendEmail()` - Email sending with CSV logging
    - `createInvite()` - Calendar invite creation
    - `listInbox()` - Inbox message retrieval with retry logic
    - `retryWithBackoff()` - Exponential backoff retry wrapper
    - `isRetryableError()` - Transient error detection
    - All validation functions (GUIDs, emails, configuration)
    - All utility functions (masking, recipient creation, CSV logging)

- **Write Operation Protection** (Automated Tests):
  - Read-only tests run by default (safe for CI/CD)
  - Write operations require explicit `MSGRAPH_INTEGRATION_WRITE=true` environment variable
  - Prevents accidental email sending and calendar modifications in automated environments

- **Test Execution Modes**:
  ```powershell
  # Interactive testing (with user prompts)
  go run -tags=integration ./src

  # Automated testing (read-only, safe)
  go test -tags=integration -v ./src

  # Automated testing (including write operations)
  $env:MSGRAPH_INTEGRATION_WRITE = "true"
  go test -tags=integration -v ./src

  # Run specific test
  go test -tags=integration -v -run TestIntegration_ListEvents ./src
  ```

### Benefits

- **Zero Code Duplication**: DRY principle achieved, single source of truth
- **Proper Build Separation**: Main app and integration tests compile independently
- **Dual Test Modes**: Interactive (manual) and automated (CI/CD) testing
- **Better Maintainability**: Shared logic changes propagate to all consumers automatically
- **Safer Testing**: Write operation protection prevents accidental API calls
- **Professional Architecture**: Industry-standard build tag usage and test patterns
- **Comprehensive Documentation**: Complete guide for both test modes in INTEGRATION_TESTS.md

### Files Modified

- **Created**:
  - `src/shared.go` (896 lines) - All shared business logic
  - `src/msgraphgolangtestingtool_integration_test.go` (254 lines) - Automated Go tests

- **Completely Rewritten**:
  - `src/msgraphgolangtestingtool.go` (551 lines) - Added `!integration` build tag, removed duplicates

- **Updated**:
  - `src/integration_test_tool.go` (297 lines) - Removed 777 lines of duplicates, uses shared.go
  - `INTEGRATION_TESTS.md` (387 lines) - Comprehensive documentation update

- **Deleted**:
  - `src/msgraphgolangtestingtool_lib.go` - Removed duplicate library causing build conflicts

### Build Verification

All build scenarios verified and passing:

1. **Main CLI App** (no integration tag):
   ```
   ✅ Build: go build -o msgraphgolangtestingtool.exe
      Size: 14MB
      Version: 1.16.1
   ```

2. **Integration Tests Compilation** (with `-tags=integration`):
   ```
   ✅ Build: go test -tags=integration -c -o integration_tests.exe
      Size: 15MB
   ```

3. **Interactive Test Tool** (with `-tags=integration`):
   ```
   ✅ Run: go run -tags=integration .
      Output: Proper environment variable prompts
   ```

### Migration Notes

- **No breaking changes** - Main CLI application functionality unchanged
- **New integration test infrastructure** - Can now run automated regression tests
- **Environment variables required** for integration tests:
  - `MSGRAPHTENANTID` - Azure AD Tenant ID
  - `MSGRAPHCLIENTID` - Application (Client) ID
  - `MSGRAPHSECRET` - Client Secret
  - `MSGRAPHMAILBOX` - Test mailbox email address
  - `MSGRAPH_INTEGRATION_WRITE=true` - Required for write operations in automated tests
- **Integration tests excluded from regular builds** by design (require real credentials)
- **See INTEGRATION_TESTS.md** for complete setup and usage guide

### Security Notes

- Integration tests require **real Azure AD credentials** and a **dedicated test mailbox**
- Never use production mailboxes for integration testing
- Write operations are protected by explicit environment variable requirement
- Credentials should be stored as environment variables or CI/CD secrets
- See INTEGRATION_TESTS.md "Security Best Practices" section for detailed guidance

