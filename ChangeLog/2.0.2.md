# Change Log: Version 2.0.2

**Release Date:** 2026-01-09

This is a security hardening patch release that implements defense-in-depth measures and comprehensive security documentation based on code review findings. While no actual vulnerabilities were present in v2.0.1 (all findings were false positives for CLI tools), this release adds additional security layers and clarifies the tool's threat model.

## Security Enhancements

### Defense-in-Depth: CRLF Injection Prevention (T101)

Added CRLF sanitization to all SMTP commands and email headers as a best practice hardening measure.

**SMTP Protocol Commands** (`internal/smtp/protocol/commands.go`):
- Added `sanitizeCRLF()` helper function to remove `\r` and `\n` characters
- Applied sanitization to all command builders:
  - `EHLO(hostname)` - Sanitizes hostname parameter
  - `HELO(hostname)` - Sanitizes hostname parameter
  - `AUTH(mechanism, response)` - Sanitizes both parameters
  - `MAILFROM(address)` - Sanitizes email address
  - `RCPTTO(address)` - Sanitizes email address
  - `VRFY(address)` - Sanitizes address parameter
  - `EXPN(mailingList)` - Sanitizes mailing list parameter

**Email Message Construction** (`cmd/smtptool/sendmail.go`):
- Added `sanitizeEmailHeader()` function to prevent header injection
- Applied sanitization to email headers:
  - `From` header - Removes CRLF sequences
  - `To` header - Sanitizes all recipient addresses
  - `Subject` header - Removes CRLF sequences
  - **Note**: Message body is intentionally NOT sanitized (may legitimately contain newlines)

**Rationale**: While CLI flags are trusted input from authorized users, this sanitization provides defense-in-depth protection if the tool is integrated into larger systems or if usage patterns change.

---

### Security Documentation (T102)

Comprehensive security documentation added to clarify tool design, threat model, and best practices.

**SECURITY.md Updates**:
- **New Section**: "Security Assumptions and Threat Model"
  - Explains CLI tool threat model vs. web application threat model
  - Documents that CLI flags and environment variables are trusted input
  - Clarifies tools are designed for authorized personnel, not untrusted input
  - Defines intended usage (direct CLI execution, automation) and non-intended usage (web services, APIs)
  - Lists defense-in-depth measures implemented in v2.0.2+
  - Provides secure deployment guidelines for system integrators
  - Sets expectations for security vulnerability reporting

**SMTP_TOOL_README.md Updates**:
- **Enhanced Section**: "Security Best Practices"
  - Added "Tool Design and Threat Model" subsection
  - Documented intended vs. non-intended usage scenarios
  - Referenced defense-in-depth measures (v2.0.2+)
  - Expanded secure usage guidelines with 5 categories:
    1. Password Safety (environment variables, credential clearing)
    2. Certificate Verification (production vs. debugging)
    3. TLS Configuration (version requirements, cipher monitoring)
    4. Logging (CSV security, permissions, sensitive data handling)
    5. Access Control (file permissions, service accounts, audit logging)
  - Cross-referenced SECURITY.md for detailed guidelines

**README.md Updates**:
- **New Section**: "Security Considerations"
  - Highlighted that tools are for authorized personnel
  - Documented trusted input model (CLI flags, environment variables)
  - Warned against untrusted web/API input usage
  - Listed v2.0.2+ defense-in-depth measures
  - Provided pre-production checklist (review SECURITY.md, credentials, access control, monitoring)
- Enhanced SECURITY.md reference in documentation list with warning icon ⚠️

---

## Code Quality Improvements

### Comments and Documentation

- Added inline comments explaining defense-in-depth rationale in code
- Documented sanitization functions with purpose and context
- Clarified that sanitization is a best practice, not a vulnerability fix

---

## Technical Details

### Files Modified

**Security Hardening (T101)**:
- `internal/smtp/protocol/commands.go` (18 lines changed)
  - Added `sanitizeCRLF()` function (4 lines)
  - Updated 7 command builders (EHLO, HELO, AUTH, MAILFROM, RCPTTO, VRFY, EXPN)
  - Added package-level documentation about defense-in-depth

- `cmd/smtptool/sendmail.go` (39 lines changed)
  - Added `sanitizeEmailHeader()` function (5 lines)
  - Updated `buildEmailMessage()` to sanitize From, To, Subject headers (14 lines)
  - Added function-level documentation about sanitization scope
  - Message body intentionally NOT sanitized (legitimate use of newlines)

**Security Documentation (T102)**:
- `SECURITY.md` (75 lines added)
  - New "Security Assumptions and Threat Model" section (63 lines)
  - Subsections: Tool Design, Trusted Input, Intended Usage, Defense-in-Depth, Deployment Guidelines, Reporting Guidelines

- `SMTP_TOOL_README.md` (44 lines changed)
  - Restructured "Security Best Practices" section
  - Added "Tool Design and Threat Model" subsection (18 lines)
  - Enhanced "Secure Usage Guidelines" with 5 detailed categories (26 lines)

- `README.md` (17 lines added)
  - New "Security Considerations" section (14 lines)
  - Enhanced SECURITY.md reference in documentation list
  - Pre-production security checklist

**Version Updates**:
- `VERSION` - Updated to 2.0.2
- `src/VERSION` - Updated to 2.0.2
- `internal/common/version/VERSION` - Updated to 2.0.2

---

## Review Context

This release addresses findings from comprehensive code and security reviews:

**Security Review Findings**: All 3 reported issues were determined to be **FALSE POSITIVES** in the context of CLI diagnostic tools:
1. **SMTP Command Injection** - FALSE POSITIVE (CLI flags are trusted input)
2. **Email Header Injection** - FALSE POSITIVE (intentional design for testing tool)
3. **Path Traversal** - FALSE POSITIVE (users need absolute paths for certificate files)

**Key Insight**: Security vulnerabilities for web applications (untrusted user input) don't apply to CLI tools where the threat model assumes authorized administrator execution.

**This Release Implements**:
- T101 (High Priority): Defense-in-depth CRLF sanitization
- T102 (High Priority): Comprehensive security documentation

**See**: `REVIEW_TASKS.md` for complete prioritized task list and `GitHub Issue #30` for tracking.

---

## Migration Notes

**No breaking changes** - This is a patch release focused on security hardening and documentation.

**For Users**:
- ✅ No action required - tools function identically to v2.0.1
- ✅ New defense-in-depth measures are transparent
- ✅ Recommended: Review [SECURITY.md](SECURITY.md) for deployment best practices

**For Developers**:
- ✅ If extending the tools, review new sanitization patterns in:
  - `internal/smtp/protocol/commands.go` (SMTP command sanitization)
  - `cmd/smtptool/sendmail.go` (email header sanitization)
- ✅ Review SECURITY.md for threat model understanding

---

## Build Verification

Both tools build successfully with version 2.0.2:

```powershell
PS> .\build-all.ps1
Building Microsoft Graph tool...
  ✓ Build successful (Size: 9.50 MB)
Building SMTP tool...
  ✓ Build successful (Size: 5.20 MB)
```

**Version Display**:
```powershell
PS> .\msgraphgolangtestingtool.exe -version
Microsoft Graph & Calendar Testing Tool - Version 2.0.2

PS> .\smtptool.exe -version
SMTP Connectivity Testing Tool - Version 2.0.2
```

---

## For Developers

**Building from Source**:
```powershell
# Build both tools
.\build-all.ps1

# Or build individually
go build -C cmd/msgraphtool -ldflags="-s -w" -o msgraphgolangtestingtool.exe
go build -C cmd/smtptool -ldflags="-s -w" -o smtptool.exe
```

**Testing**:
```powershell
# Test SMTP tool with sanitization
.\smtptool.exe -action testconnect -host smtp.example.com -port 25

# Test Graph tool (unchanged)
.\msgraphgolangtestingtool.exe -version
```

---

## Next Steps

**Completed for v2.0.2**: P1 (High Priority) tasks from REVIEW_TASKS.md
- ✅ T101: Defense-in-depth CRLF sanitization
- ✅ T102: Comprehensive security documentation

**Planned for v2.1.0**: P2 (Medium Priority) reliability improvements
- T201: Add timeout to SMTP response reading (3-4 hours)
- T202: Improve CSV log file permissions (4-6 hours)
- T203: Add password masking in error messages (2-3 hours)
- T204: Enhance path validation logic clarity (1-2 hours)

**See**: `REVIEW_TASKS.md` for complete roadmap and GitHub Issue #30 for tracking.

---

**Full Changelog**: See commit history for detailed implementation of security hardening.

**References**:
- REVIEW_TASKS.md - Complete prioritized task list
- GitHub Issue #30 - Security hardening tracking
- SECURITY.md - Complete threat model and best practices
