name: Build and Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]
        include:
          - os: windows-latest
            graph_binary: msgraphgolangtestingtool.exe
            smtp_binary: smtptool.exe
            artifact_name: msgraphgolangtestingtool-windows
            zip_name: msgraphgolangtestingtool-windows.zip
          - os: ubuntu-latest
            graph_binary: msgraphgolangtestingtool
            smtp_binary: smtptool
            artifact_name: msgraphgolangtestingtool-linux
            zip_name: msgraphgolangtestingtool-linux.zip
          - os: macos-latest
            graph_binary: msgraphgolangtestingtool
            smtp_binary: smtptool
            artifact_name: msgraphgolangtestingtool-macos
            zip_name: msgraphgolangtestingtool-macos.zip

    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'

    - name: Build Microsoft Graph Tool (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        cd cmd/msgraphtool
        go build -ldflags="-s -w" -o ../../${{ matrix.graph_binary }}
        cd ../..

    - name: Build SMTP Tool (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        cd cmd/smtptool
        go build -ldflags="-s -w" -o ../../${{ matrix.smtp_binary }}
        cd ../..

    - name: Build Microsoft Graph Tool (Linux/macOS)
      if: matrix.os != 'windows-latest'
      run: |
        cd cmd/msgraphtool
        go build -ldflags="-s -w" -o ../../${{ matrix.graph_binary }}
        cd ../..

    - name: Build SMTP Tool (Linux/macOS)
      if: matrix.os != 'windows-latest'
      run: |
        cd cmd/smtptool
        go build -ldflags="-s -w" -o ../../${{ matrix.smtp_binary }}
        cd ../..

    - name: Verify build output (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        if (Test-Path ${{ matrix.graph_binary }}) {
          Write-Host "✓ Graph tool build successful: ${{ matrix.graph_binary }}"
          Get-Item ${{ matrix.graph_binary }} | Select-Object Name, Length
        } else {
          Write-Error "✗ Graph tool build failed"
          exit 1
        }
        if (Test-Path ${{ matrix.smtp_binary }}) {
          Write-Host "✓ SMTP tool build successful: ${{ matrix.smtp_binary }}"
          Get-Item ${{ matrix.smtp_binary }} | Select-Object Name, Length
        } else {
          Write-Error "✗ SMTP tool build failed"
          exit 1
        }

    - name: Verify build output (Linux/macOS)
      if: matrix.os != 'windows-latest'
      run: |
        if [ -f "${{ matrix.graph_binary }}" ]; then
          echo "✓ Graph tool build successful: ${{ matrix.graph_binary }}"
          ls -lh ${{ matrix.graph_binary }}
        else
          echo "✗ Graph tool build failed"
          exit 1
        fi
        if [ -f "${{ matrix.smtp_binary }}" ]; then
          echo "✓ SMTP tool build successful: ${{ matrix.smtp_binary }}"
          ls -lh ${{ matrix.smtp_binary }}
        else
          echo "✗ SMTP tool build failed"
          exit 1
        fi

    - name: Create ZIP archive (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        Compress-Archive -Path ${{ matrix.graph_binary }},${{ matrix.smtp_binary }},README.md,SMTP_TOOL_README.md,BUILD.md,EXAMPLES.md,LICENSE -DestinationPath ${{ matrix.zip_name }}
        Write-Host "Created ZIP archive: ${{ matrix.zip_name }}"
        Get-Item ${{ matrix.zip_name }} | Select-Object Name, Length

    - name: Create ZIP archive (Linux/macOS)
      if: matrix.os != 'windows-latest'
      run: |
        zip ${{ matrix.zip_name }} ${{ matrix.graph_binary }} ${{ matrix.smtp_binary }} README.md SMTP_TOOL_README.md BUILD.md EXAMPLES.md LICENSE
        echo "Created ZIP archive: ${{ matrix.zip_name }}"
        ls -lh ${{ matrix.zip_name }}

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: ${{ matrix.zip_name }}

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ matrix.zip_name }}
        body: |
          ## Microsoft Graph & SMTP Testing Tools

          Portable CLI tools for comprehensive email infrastructure testing - both cloud (Exchange Online via Microsoft Graph) and on-premises (SMTP servers).

          ### What's Included

          Each ZIP archive contains:
          - **msgraphgolangtestingtool** - Microsoft Graph API tool for Exchange Online
          - **smtptool** - SMTP connectivity testing tool with comprehensive TLS diagnostics
          - **README.md** - Main documentation
          - **SMTP_TOOL_README.md** - Complete SMTP tool guide
          - **BUILD.md** - Build instructions for both tools
          - **EXAMPLES.md** - Microsoft Graph tool usage examples
          - **LICENSE** - MIT License

          ### Installation

          **Windows:**
          1. Download `msgraphgolangtestingtool-windows.zip`
          2. Extract the ZIP file
          3. Run `msgraphgolangtestingtool.exe` or `smtptool.exe` directly

          **Linux:**
          1. Download `msgraphgolangtestingtool-linux.zip`
          2. Extract: `unzip msgraphgolangtestingtool-linux.zip`
          3. Make executable: `chmod +x msgraphgolangtestingtool smtptool`
          4. Run: `./msgraphgolangtestingtool` or `./smtptool`

          **macOS:**
          1. Download `msgraphgolangtestingtool-macos.zip`
          2. Extract: `unzip msgraphgolangtestingtool-macos.zip`
          3. Make executable: `chmod +x msgraphgolangtestingtool smtptool`
          4. Run: `./msgraphgolangtestingtool` or `./smtptool`

          **Note for macOS:** If you see "cannot be opened because the developer cannot be verified":
          - Right-click the binary and select "Open", or
          - Run: `xattr -d com.apple.quarantine msgraphgolangtestingtool smtptool`

          ### Quick Start

          **Microsoft Graph Tool:**
          ```bash
          # Windows
          .\msgraphgolangtestingtool.exe -tenantid "..." -clientid "..." -secret "..." -mailbox "user@example.com" -action getinbox

          # Linux/macOS
          ./msgraphgolangtestingtool -tenantid "..." -clientid "..." -secret "..." -mailbox "user@example.com" -action getinbox
          ```

          **SMTP Tool:**
          ```bash
          # Windows - Test connectivity
          .\smtptool.exe -action testconnect -host smtp.example.com -port 25

          # Windows - Comprehensive TLS diagnostics
          .\smtptool.exe -action teststarttls -host smtp.example.com -port 587

          # Linux/macOS - Test connectivity
          ./smtptool -action testconnect -host smtp.example.com -port 25

          # Linux/macOS - Comprehensive TLS diagnostics
          ./smtptool -action teststarttls -host smtp.example.com -port 587
          ```

          ### Documentation
          - **README.md** - Overview and quick start for both tools
          - **SMTP_TOOL_README.md** - Complete SMTP tool documentation with all actions
          - **EXAMPLES.md** - Detailed Microsoft Graph tool examples
          - **BUILD.md** - Build from source instructions
          - Online: [GitHub Repository](https://github.com/${{ github.repository }})

          ### Tools Overview

          **msgraphgolangtestingtool** - Microsoft Graph API operations:
          - Send emails, create calendar events
          - List inbox messages and calendar events
          - Check availability, export data
          - Multiple authentication methods (Client Secret, PFX Certificate, Windows Certificate Store)

          **smtptool** - SMTP connectivity testing:
          - Test basic SMTP connectivity with capability detection
          - Comprehensive TLS/SSL handshake analysis
          - Certificate chain validation and expiry warnings
          - SMTP authentication testing
          - Send test emails
          - Exchange server detection (2003-2019)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
