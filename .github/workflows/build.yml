name: Build and Release

on:
  push:
    tags:
      - 'v*'
  pull_request:
    branches: [main]

permissions:
  contents: write

jobs:
  # Test job runs on all platforms
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'

    - name: Run Tests
      run: go test -v -race ./...

    - name: Check Test Coverage
      if: matrix.os == 'ubuntu-latest'
      run: |
        go test -coverprofile=coverage.out ./...
        go tool cover -func=coverage.out | tail -1

  # Lint job runs only on Linux
  lint:
    runs-on: ubuntu-latest
    continue-on-error: true  # Allow lint to report issues without blocking build
    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'

    - name: Run golangci-lint
      uses: golangci/golangci-lint-action@v6
      with:
        version: latest
        args: --timeout=5m

  # Build job runs after test, only on tag push
  build:
    needs: [test]
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]
        include:
          - os: windows-latest
            ext: .exe
            artifact_name: gomailtesttool-windows-amd64
            zip_name: gomailtesttool-windows-amd64.zip
            goarch: amd64
          - os: ubuntu-latest
            ext: ''
            artifact_name: gomailtesttool-linux-amd64
            zip_name: gomailtesttool-linux-amd64.zip
            goarch: amd64
          - os: macos-latest
            ext: ''
            artifact_name: gomailtesttool-macos-arm64
            zip_name: gomailtesttool-macos-arm64.zip
            goarch: arm64

    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'

    - name: Create bin directory
      run: mkdir -p bin

    - name: Build all tools
      env:
        GOARCH: ${{ matrix.goarch }}
      run: |
        go build -ldflags="-s -w" -o bin/msgraphtool${{ matrix.ext }} ./cmd/msgraphtool
        go build -ldflags="-s -w" -o bin/smtptool${{ matrix.ext }} ./cmd/smtptool
        go build -ldflags="-s -w" -o bin/imaptool${{ matrix.ext }} ./cmd/imaptool
        go build -ldflags="-s -w" -o bin/pop3tool${{ matrix.ext }} ./cmd/pop3tool
        go build -ldflags="-s -w" -o bin/jmaptool${{ matrix.ext }} ./cmd/jmaptool

    - name: Verify build output (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        $tools = @("msgraphtool", "smtptool", "imaptool", "pop3tool", "jmaptool")
        foreach ($tool in $tools) {
          $binary = "bin\$tool${{ matrix.ext }}"
          if (Test-Path $binary) {
            Write-Host "✓ $tool build successful"
            Get-Item $binary | Select-Object Name, Length
          } else {
            Write-Error "✗ $tool build failed"
            exit 1
          }
        }

    - name: Verify build output (Linux/macOS)
      if: matrix.os != 'windows-latest'
      run: |
        for tool in msgraphtool smtptool imaptool pop3tool jmaptool; do
          if [ -f "bin/$tool${{ matrix.ext }}" ]; then
            echo "✓ $tool build successful"
            ls -lh "bin/$tool${{ matrix.ext }}"
          else
            echo "✗ $tool build failed"
            exit 1
          fi
        done

    - name: Create ZIP archive (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        Compress-Archive -Path bin\msgraphtool${{ matrix.ext }},bin\smtptool${{ matrix.ext }},bin\imaptool${{ matrix.ext }},bin\pop3tool${{ matrix.ext }},bin\jmaptool${{ matrix.ext }},README.md,SMTP_TOOL_README.md,BUILD.md,EXAMPLES.md,LICENSE -DestinationPath ${{ matrix.zip_name }}
        Write-Host "Created ZIP archive: ${{ matrix.zip_name }}"
        Get-Item ${{ matrix.zip_name }} | Select-Object Name, Length

    - name: Create ZIP archive (Linux/macOS)
      if: matrix.os != 'windows-latest'
      run: |
        cd bin && zip ../${{ matrix.zip_name }} msgraphtool${{ matrix.ext }} smtptool${{ matrix.ext }} imaptool${{ matrix.ext }} pop3tool${{ matrix.ext }} jmaptool${{ matrix.ext }} && cd ..
        zip -u ${{ matrix.zip_name }} README.md SMTP_TOOL_README.md BUILD.md EXAMPLES.md LICENSE
        echo "Created ZIP archive: ${{ matrix.zip_name }}"
        ls -lh ${{ matrix.zip_name }}

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: ${{ matrix.zip_name }}

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ matrix.zip_name }}
        body: |
          ## gomailtesttool Suite - Email Infrastructure Testing Tools

          Portable CLI tools for comprehensive email infrastructure testing - covering cloud services (Exchange Online via Microsoft Graph), SMTP, IMAP, POP3, and JMAP protocols.

          ### What's Included

          Each ZIP archive contains 5 tools:
          - **msgraphtool** - Microsoft Graph API tool for Exchange Online
          - **smtptool** - SMTP connectivity and TLS testing
          - **imaptool** - IMAP server testing with XOAUTH2 support
          - **pop3tool** - POP3 server testing with XOAUTH2 support
          - **jmaptool** - JMAP protocol testing

          Plus documentation:
          - **README.md** - Main documentation
          - **SMTP_TOOL_README.md** - Complete SMTP tool guide
          - **BUILD.md** - Build instructions
          - **EXAMPLES.md** - Usage examples
          - **LICENSE** - MIT License

          ### Installation

          **Windows (amd64):**
          1. Download `gomailtesttool-windows-amd64.zip`
          2. Extract the ZIP file
          3. Run any tool directly (e.g., `smtptool.exe -help`)

          **Linux (amd64):**
          1. Download `gomailtesttool-linux-amd64.zip`
          2. Extract: `unzip gomailtesttool-linux-amd64.zip`
          3. Make executable: `chmod +x *tool`
          4. Run: `./smtptool -help`

          **macOS (Apple Silicon/arm64):**
          1. Download `gomailtesttool-macos-arm64.zip`
          2. Extract: `unzip gomailtesttool-macos-arm64.zip`
          3. Make executable: `chmod +x *tool`
          4. Run: `./smtptool -help`

          **Note for macOS:** If you see "cannot be opened because the developer cannot be verified":
          - Right-click the binary and select "Open", or
          - Run: `xattr -d com.apple.quarantine *tool`

          ### Quick Start Examples

          **SMTP Testing:**
          ```bash
          # Test connectivity
          ./smtptool -action testconnect -host smtp.example.com -port 25

          # TLS diagnostics
          ./smtptool -action teststarttls -host smtp.example.com -port 587
          ```

          **IMAP Testing:**
          ```bash
          # Test connection
          ./imaptool -action testconnect -host imap.gmail.com -imaps

          # List folders with OAuth2
          ./imaptool -action listfolders -host imap.gmail.com -imaps \
            -username user@gmail.com -accesstoken "ya29..."
          ```

          **POP3 Testing:**
          ```bash
          # Test connection
          ./pop3tool -action testconnect -host pop.gmail.com -pop3s

          # List mail
          ./pop3tool -action listmail -host pop.gmail.com -pop3s \
            -username user@gmail.com -password "app-password"
          ```

          **JMAP Testing:**
          ```bash
          # Discover session
          ./jmaptool -action testconnect -host jmap.fastmail.com

          # Get mailboxes
          ./jmaptool -action getmailboxes -host jmap.fastmail.com \
            -username user@fastmail.com -accesstoken "token"
          ```

          **Microsoft Graph:**
          ```bash
          ./msgraphtool -tenantid "..." -clientid "..." -secret "..." \
            -mailbox "user@example.com" -action getinbox
          ```

          ### Tools Overview

          | Tool | Protocol | Ports | Auth Methods |
          |------|----------|-------|--------------|
          | smtptool | SMTP | 25, 587, 465 | PLAIN, LOGIN, CRAM-MD5, XOAUTH2 |
          | imaptool | IMAP | 143, 993 | PLAIN, LOGIN, XOAUTH2 |
          | pop3tool | POP3 | 110, 995 | USER/PASS, APOP, XOAUTH2 |
          | jmaptool | JMAP | 443 | Basic, Bearer |
          | msgraphtool | Graph API | 443 | Client Secret, Certificate, Bearer |

          ### Documentation
          - Online: [GitHub Repository](https://github.com/${{ github.repository }})
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
